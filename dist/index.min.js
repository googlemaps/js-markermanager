this.google=this.google||{},this.google.maps=this.google.maps||{},this.google.maps.plugins=this.google.maps.plugins||{},this.google.maps.plugins.markermanager=function(i){"use strict";function e(i,e){if(!(i instanceof e))throw new TypeError("Cannot call a class as a function")}function t(i,e){for(var t=0;t<e.length;t++){var s=e[t];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(i,s.key,s)}}function s(i,e,s){return e&&t(i.prototype,e),s&&t(i,s),Object.defineProperty(i,"prototype",{writable:!1}),i}function n(i,e){return new google.maps.Point(~~(.5+(n=i.lng(),(1+n/180)*(2<<e+6))),~~(.5+(t=i.lat(),s=Math.sin(t*Math.PI/180),(1-.5/Math.PI*Math.log((1+s)/(1-s)))*(2<<e+6))));var t,s,n}var o=function(){function i(t,s){e(this,i),this.z=s,this.minX=Math.min(t[0].x,t[1].x),this.maxX=Math.max(t[0].x,t[1].x),this.minY=Math.min(t[0].y,t[1].y),this.maxY=Math.max(t[0].y,t[1].y)}return s(i,[{key:"equals",value:function(i){return this.maxX===i.maxX&&this.maxY===i.maxY&&this.minX===i.minX&&this.minY===i.minY}},{key:"containsPoint",value:function(i){return this.minX<=i.x&&this.maxX>=i.x&&this.minY<=i.y&&this.maxY>=i.y}}]),i}(),r=function(){function i(t,s){var n=this,o=s.maxZoom,r=void 0===o?19:o,a=s.trackMarkers,h=s.shown,l=void 0===h||h,_=s.borderPadding,d=void 0===_?100:_;e(this,i),this._tileSize=1024,this._map=t,this._mapZoom=t.getZoom(),this._maxZoom=r,this._trackMarkers=a,this._swPadding=new google.maps.Size(-d,d),this._nePadding=new google.maps.Size(d,-d),this._gridWidth={},this._grid=[],this._grid[this._maxZoom]=[],this._numMarkers={},this._numMarkers[this._maxZoom]=0,this.shownMarkers=0,this.shown=l,google.maps.event.addListenerOnce(t,"idle",(function(){n._initialize()}))}return s(i,[{key:"_initialize",value:function(){var i=this._map.mapTypes;for(var e in i)e in i&&i.get(e)&&"number"===i.get(e).maxZoom&&this._map.mapTypes.get(e).maxZoom;google.maps.event.addListener(this._map,"dragend",this._onMapMoveEnd.bind(this)),google.maps.event.addListener(this._map,"idle",this._onMapMoveEnd.bind(this)),google.maps.event.addListener(this._map,"zoom_changed",this._onMapMoveEnd.bind(this)),this.resetManager(),this._shownBounds=this._getMapGridBounds(),google.maps.event.trigger(this,"loaded")}},{key:"_removeOverlay",value:function(i){i.setMap(null),this.shownMarkers--}},{key:"_addOverlay",value:function(i){this.shown&&(i.setMap(this._map),this.shownMarkers++)}},{key:"resetManager",value:function(){for(var i=256,e=0;e<=this._maxZoom;++e)this._grid[e]=[],this._numMarkers[e]=0,this._gridWidth[e]=Math.ceil(i/this._tileSize),i<<=1}},{key:"clearMarkers",value:function(){this._processAll(this._shownBounds,this._removeOverlay.bind(this)),this.resetManager()}},{key:"_getTilePoint",value:function(i,e,t){var s=n(i,e);return new google.maps.Point(Math.floor((s.x+t.width)/this._tileSize),Math.floor((s.y+t.height)/this._tileSize))}},{key:"_addMarkerBatch",value:function(i,e,t){var s=this,n=i.getPosition();i.set("__minZoom",e),this._trackMarkers&&google.maps.event.addListener(i,"changed",(function(i,e,t){s._onMarkerMoved(i,e,t)}));for(var o=this._getTilePoint(n,t,new google.maps.Size(0,0)),r=t;r>=e;r--){this._getGridCellCreate(o.x,o.y,r).push(i),o.x=o.x>>1,o.y=o.y>>1}}},{key:"_isGridPointVisible",value:function(i){var e=this._shownBounds.minY<=i.y&&i.y<=this._shownBounds.maxY,t=this._shownBounds.minX,s=t<=i.x&&i.x<=this._shownBounds.maxX;if(!s&&t<0){var n=this._gridWidth[this._shownBounds.z];s=t+n<=i.x&&i.x<=n-1}return e&&s}},{key:"_onMarkerMoved",value:function(i,e,t){for(var s=this._maxZoom,n=!1,o=this._getTilePoint(e,s,new google.maps.Size(0,0)),r=this._getTilePoint(t,s,new google.maps.Size(0,0));s>=0&&(o.x!==r.x||o.y!==r.y);){var a=this._getGridCellNoCreate(o.x,o.y,s);a&&this._removeMarkerFromCell(a,i)&&this._getGridCellCreate(r.x,r.y,s).push(i),s===this._mapZoom&&(this._isGridPointVisible(o)?this._isGridPointVisible(r)||(this._removeOverlay(i),n=!0):this._isGridPointVisible(r)&&(this._addOverlay(i),n=!0)),o.x=o.x>>1,o.y=o.y>>1,r.x=r.x>>1,r.y=r.y>>1,--s}n&&this._notifyListeners()}},{key:"removeMarker",value:function(i){for(var e=this._maxZoom,t=!1,s=i.getPosition(),n=this._getTilePoint(s,e,new google.maps.Size(0,0));e>=0;){var o=this._getGridCellNoCreate(n.x,n.y,e);o&&this._removeMarkerFromCell(o,i),e===this._mapZoom&&this._isGridPointVisible(n)&&(this._removeOverlay(i),t=!0),n.x=n.x>>1,n.y=n.y>>1,--e}t&&this._notifyListeners(),this._numMarkers[i.get("__minZoom")]--}},{key:"addMarkers",value:function(i,e,t){t=this._getOptmaxZoom(t);for(var s=i.length-1;s>=0;s--)this._addMarkerBatch(i[s],e,t);this._numMarkers[e]+=i.length}},{key:"_getOptmaxZoom",value:function(i){return i||this._maxZoom}},{key:"getMarkerCount",value:function(i){for(var e=0,t=0;t<=i;t++)e+=this._numMarkers[t];return e}},{key:"getMarker",value:function(i,e,t){var s=new google.maps.LatLng(i,e),n=this._getTilePoint(s,t,new google.maps.Size(0,0)),o=new google.maps.Marker({position:s}),r=this._getGridCellNoCreate(n.x,n.y,t);if(void 0!==r)for(var a=0;a<r.length;a++)i===r[a].getPosition().lat()&&e===r[a].getPosition().lng()&&(o=r[a]);return o}},{key:"addMarker",value:function(i,e,t){t=this._getOptmaxZoom(t),this._addMarkerBatch(i,e,t);var s=this._getTilePoint(i.getPosition(),this._mapZoom,new google.maps.Size(0,0));this._isGridPointVisible(s)&&e<=this._shownBounds.z&&this._shownBounds.z<=t&&(this._addOverlay(i),this._notifyListeners()),this._numMarkers[e]++}},{key:"_getGridCellCreate",value:function(i,e,t){return i<0&&(i+=this._gridWidth[t]),this._grid[t]||(this._grid[t]=[]),this._grid[t][i]||(this._grid[t][i]=[]),this._grid[t][i][e]||(this._grid[t][i][e]=[]),this._grid[t][i][e]}},{key:"_getGridCellNoCreate",value:function(i,e,t){return i<0&&(i+=this._gridWidth[t]),this._grid[t]&&this._grid[t][i]&&this._grid[t][i][e]?this._grid[t][i][e]:null}},{key:"_getGridBounds",value:function(i,e,t,s){e=Math.min(e,this._maxZoom);var n=i.getSouthWest(),r=i.getNorthEast(),a=this._getTilePoint(n,e,t),h=this._getTilePoint(r,e,s),l=this._gridWidth[e];(r.lng()<n.lng()||h.x<a.x)&&(a.x-=l),h.x-a.x+1>=l&&(a.x=0,h.x=l-1);var _=new o([a,h],e);return _.z=e,_}},{key:"_getMapGridBounds",value:function(){return this._getGridBounds(this._map.getBounds(),this._mapZoom,this._swPadding,this._nePadding)}},{key:"_onMapMoveEnd",value:function(){window.setTimeout(this._updateMarkers.bind(this),0)}},{key:"visible",value:function(){return!!this.shown}},{key:"isHidden",value:function(){return!this.shown}},{key:"show",value:function(){this.shown=!0,this.refresh()}},{key:"hide",value:function(){this.shown=!1,this.refresh()}},{key:"toggle",value:function(){this.shown=!this.shown,this.refresh()}},{key:"refresh",value:function(){this.shownMarkers>0&&this._processAll(this._shownBounds,this._removeOverlay.bind(this)),this.show&&this._processAll(this._shownBounds,this._addOverlay.bind(this)),this._notifyListeners()}},{key:"_updateMarkers",value:function(){this._mapZoom=this._map.getZoom();var i=this._getMapGridBounds();i.equals(this._shownBounds)&&i.z===this._shownBounds.z||(i.z!==this._shownBounds.z?(this._processAll(this._shownBounds,this._removeOverlay.bind(this)),this.show&&this._processAll(i,this._addOverlay.bind(this))):(this._rectangleDiff(this._shownBounds,i,this._removeCellMarkers.bind(this)),this.show&&this._rectangleDiff(i,this._shownBounds,this._addCellMarkers.bind(this))),this._shownBounds=i,this._notifyListeners())}},{key:"_notifyListeners",value:function(){google.maps.event.trigger(this,"changed",this._shownBounds,this.shownMarkers)}},{key:"_processAll",value:function(i,e){for(var t=i.minX;t<=i.maxX;t++)for(var s=i.minY;s<=i.maxY;s++)this._processCellMarkers(t,s,i.z,e)}},{key:"_processCellMarkers",value:function(i,e,t,s){var n=this._getGridCellNoCreate(i,e,t);if(n)for(var o=n.length-1;o>=0;o--)s(n[o])}},{key:"_removeCellMarkers",value:function(i,e,t){this._processCellMarkers(i,e,t,this._removeOverlay.bind(this))}},{key:"_addCellMarkers",value:function(i,e,t){this._processCellMarkers(i,e,t,this._addOverlay.bind(this))}},{key:"_rectangleDiff",value:function(i,e,t){this._rectangleDiffCoords(i,e,(function(e,s){t(e,s,i.z)}))}},{key:"_rectangleDiffCoords",value:function(i,e,t){var s,n,o=i.minX,r=i.minY,a=i.maxX,h=i.maxY,l=e.minX,_=e.minY,d=e.maxX,u=e.maxY;for(s=o;s<=a;s++){for(n=r;n<=h&&n<_;n++)t(s,n);for(n=Math.max(u+1,r);n<=h;n++)t(s,n)}for(n=Math.max(r,_);n<=Math.min(h,u);n++){for(s=Math.min(a+1,l)-1;s>=o;s--)t(s,n);for(s=Math.max(o,d+1);s<=a;s++)t(s,n)}}},{key:"_removeMarkerFromCell",value:function(i,e){for(var t=0,s=0;s<i.length;++s)i[s]===e&&(i.splice(s--,1),t++);return t}}]),i}();return i.MarkerManager=r,Object.defineProperty(i,"__esModule",{value:!0}),i}({});
