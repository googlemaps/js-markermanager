!function(e,i){"object"==typeof exports&&"undefined"!=typeof module?i(exports,require("core-js/modules/es.array.splice.js")):"function"==typeof define&&define.amd?define(["exports","core-js/modules/es.array.splice.js"],i):i(((e="undefined"!=typeof globalThis?globalThis:e||self).google=e.google||{},e.google.maps=e.google.maps||{},e.google.maps.plugins=e.google.maps.plugins||{},e.google.maps.plugins.markermanager={}))}(this,(function(e){"use strict";function i(e,i){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}function t(e,i){for(var t=0;t<i.length;t++){var s=i[t];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function s(e,i,s){return i&&t(e.prototype,i),s&&t(e,s),Object.defineProperty(e,"prototype",{writable:!1}),e}function o(e,i){return new google.maps.Point(~~(.5+(o=e.lng(),(1+o/180)*(2<<i+6))),~~(.5+(t=e.lat(),s=Math.sin(t*Math.PI/180),(1-.5/Math.PI*Math.log((1+s)/(1-s)))*(2<<i+6))));var t,s,o}var n=function(){function e(t,s){i(this,e),this.z=s,this.minX=Math.min(t[0].x,t[1].x),this.maxX=Math.max(t[0].x,t[1].x),this.minY=Math.min(t[0].y,t[1].y),this.maxY=Math.max(t[0].y,t[1].y)}return s(e,[{key:"equals",value:function(e){return this.maxX===e.maxX&&this.maxY===e.maxY&&this.minX===e.minX&&this.minY===e.minY}},{key:"containsPoint",value:function(e){return this.minX<=e.x&&this.maxX>=e.x&&this.minY<=e.y&&this.maxY>=e.y}}]),e}(),r=function(){function e(t,s){var o=this,n=s.maxZoom,r=void 0===n?19:n,a=s.trackMarkers,h=s.shown,l=void 0===h||h,d=s.borderPadding,_=void 0===d?100:d;i(this,e),this._tileSize=1024,this._map=t,this._mapZoom=t.getZoom(),this._maxZoom=r,this._trackMarkers=a,this._swPadding=new google.maps.Size(-_,_),this._nePadding=new google.maps.Size(_,-_),this._gridWidth={},this._grid=[],this._grid[this._maxZoom]=[],this._numMarkers={},this._numMarkers[this._maxZoom]=0,this.shownMarkers=0,this.shown=l,google.maps.event.addListenerOnce(t,"idle",(function(){o._initialize()}))}return s(e,[{key:"_initialize",value:function(){var e=this._map.mapTypes;for(var i in e)i in e&&e.get(i)&&"number"===e.get(i).maxZoom&&this._map.mapTypes.get(i).maxZoom;google.maps.event.addListener(this._map,"dragend",this._onMapMoveEnd.bind(this)),google.maps.event.addListener(this._map,"idle",this._onMapMoveEnd.bind(this)),google.maps.event.addListener(this._map,"zoom_changed",this._onMapMoveEnd.bind(this)),this.resetManager(),this._shownBounds=this._getMapGridBounds(),google.maps.event.trigger(this,"loaded")}},{key:"_removeOverlay",value:function(e){e.setMap(null),this.shownMarkers--}},{key:"_addOverlay",value:function(e){this.shown&&(e.setMap(this._map),this.shownMarkers++)}},{key:"resetManager",value:function(){for(var e=256,i=0;i<=this._maxZoom;++i)this._grid[i]=[],this._numMarkers[i]=0,this._gridWidth[i]=Math.ceil(e/this._tileSize),e<<=1}},{key:"clearMarkers",value:function(){this._processAll(this._shownBounds,this._removeOverlay.bind(this)),this.resetManager()}},{key:"_getTilePoint",value:function(e,i,t){var s=o(e,i);return new google.maps.Point(Math.floor((s.x+t.width)/this._tileSize),Math.floor((s.y+t.height)/this._tileSize))}},{key:"_addMarkerBatch",value:function(e,i,t){var s=this,o=e.getPosition();e.set("__minZoom",i),this._trackMarkers&&google.maps.event.addListener(e,"changed",(function(e,i,t){s._onMarkerMoved(e,i,t)}));for(var n=this._getTilePoint(o,t,new google.maps.Size(0,0)),r=t;r>=i;r--){this._getGridCellCreate(n.x,n.y,r).push(e),n.x=n.x>>1,n.y=n.y>>1}}},{key:"_isGridPointVisible",value:function(e){var i=this._shownBounds.minY<=e.y&&e.y<=this._shownBounds.maxY,t=this._shownBounds.minX,s=t<=e.x&&e.x<=this._shownBounds.maxX;if(!s&&t<0){var o=this._gridWidth[this._shownBounds.z];s=t+o<=e.x&&e.x<=o-1}return i&&s}},{key:"_onMarkerMoved",value:function(e,i,t){for(var s=this._maxZoom,o=!1,n=this._getTilePoint(i,s,new google.maps.Size(0,0)),r=this._getTilePoint(t,s,new google.maps.Size(0,0));s>=0&&(n.x!==r.x||n.y!==r.y);){var a=this._getGridCellNoCreate(n.x,n.y,s);a&&this._removeMarkerFromCell(a,e)&&this._getGridCellCreate(r.x,r.y,s).push(e),s===this._mapZoom&&(this._isGridPointVisible(n)?this._isGridPointVisible(r)||(this._removeOverlay(e),o=!0):this._isGridPointVisible(r)&&(this._addOverlay(e),o=!0)),n.x=n.x>>1,n.y=n.y>>1,r.x=r.x>>1,r.y=r.y>>1,--s}o&&this._notifyListeners()}},{key:"removeMarker",value:function(e){for(var i=this._maxZoom,t=!1,s=e.getPosition(),o=this._getTilePoint(s,i,new google.maps.Size(0,0));i>=0;){var n=this._getGridCellNoCreate(o.x,o.y,i);n&&this._removeMarkerFromCell(n,e),i===this._mapZoom&&this._isGridPointVisible(o)&&(this._removeOverlay(e),t=!0),o.x=o.x>>1,o.y=o.y>>1,--i}t&&this._notifyListeners(),this._numMarkers[e.get("__minZoom")]--}},{key:"addMarkers",value:function(e,i,t){t=this._getOptmaxZoom(t);for(var s=e.length-1;s>=0;s--)this._addMarkerBatch(e[s],i,t);this._numMarkers[i]+=e.length}},{key:"_getOptmaxZoom",value:function(e){return e||this._maxZoom}},{key:"getMarkerCount",value:function(e){for(var i=0,t=0;t<=e;t++)i+=this._numMarkers[t];return i}},{key:"getMarker",value:function(e,i,t){var s=new google.maps.LatLng(e,i),o=this._getTilePoint(s,t,new google.maps.Size(0,0)),n=new google.maps.Marker({position:s}),r=this._getGridCellNoCreate(o.x,o.y,t);if(void 0!==r)for(var a=0;a<r.length;a++)e===r[a].getPosition().lat()&&i===r[a].getPosition().lng()&&(n=r[a]);return n}},{key:"addMarker",value:function(e,i,t){t=this._getOptmaxZoom(t),this._addMarkerBatch(e,i,t);var s=this._getTilePoint(e.getPosition(),this._mapZoom,new google.maps.Size(0,0));this._isGridPointVisible(s)&&i<=this._shownBounds.z&&this._shownBounds.z<=t&&(this._addOverlay(e),this._notifyListeners()),this._numMarkers[i]++}},{key:"_getGridCellCreate",value:function(e,i,t){return e<0&&(e+=this._gridWidth[t]),this._grid[t]||(this._grid[t]=[]),this._grid[t][e]||(this._grid[t][e]=[]),this._grid[t][e][i]||(this._grid[t][e][i]=[]),this._grid[t][e][i]}},{key:"_getGridCellNoCreate",value:function(e,i,t){return e<0&&(e+=this._gridWidth[t]),this._grid[t]&&this._grid[t][e]&&this._grid[t][e][i]?this._grid[t][e][i]:null}},{key:"_getGridBounds",value:function(e,i,t,s){i=Math.min(i,this._maxZoom);var o=e.getSouthWest(),r=e.getNorthEast(),a=this._getTilePoint(o,i,t),h=this._getTilePoint(r,i,s),l=this._gridWidth[i];(r.lng()<o.lng()||h.x<a.x)&&(a.x-=l),h.x-a.x+1>=l&&(a.x=0,h.x=l-1);var d=new n([a,h],i);return d.z=i,d}},{key:"_getMapGridBounds",value:function(){return this._getGridBounds(this._map.getBounds(),this._mapZoom,this._swPadding,this._nePadding)}},{key:"_onMapMoveEnd",value:function(){window.setTimeout(this._updateMarkers.bind(this),0)}},{key:"visible",value:function(){return!!this.shown}},{key:"isHidden",value:function(){return!this.shown}},{key:"show",value:function(){this.shown=!0,this.refresh()}},{key:"hide",value:function(){this.shown=!1,this.refresh()}},{key:"toggle",value:function(){this.shown=!this.shown,this.refresh()}},{key:"refresh",value:function(){this.shownMarkers>0&&this._processAll(this._shownBounds,this._removeOverlay.bind(this)),this.show&&this._processAll(this._shownBounds,this._addOverlay.bind(this)),this._notifyListeners()}},{key:"_updateMarkers",value:function(){this._mapZoom=this._map.getZoom();var e=this._getMapGridBounds();e.equals(this._shownBounds)&&e.z===this._shownBounds.z||(e.z!==this._shownBounds.z?(this._processAll(this._shownBounds,this._removeOverlay.bind(this)),this.show&&this._processAll(e,this._addOverlay.bind(this))):(this._rectangleDiff(this._shownBounds,e,this._removeCellMarkers.bind(this)),this.show&&this._rectangleDiff(e,this._shownBounds,this._addCellMarkers.bind(this))),this._shownBounds=e,this._notifyListeners())}},{key:"_notifyListeners",value:function(){google.maps.event.trigger(this,"changed",this._shownBounds,this.shownMarkers)}},{key:"_processAll",value:function(e,i){for(var t=e.minX;t<=e.maxX;t++)for(var s=e.minY;s<=e.maxY;s++)this._processCellMarkers(t,s,e.z,i)}},{key:"_processCellMarkers",value:function(e,i,t,s){var o=this._getGridCellNoCreate(e,i,t);if(o)for(var n=o.length-1;n>=0;n--)s(o[n])}},{key:"_removeCellMarkers",value:function(e,i,t){this._processCellMarkers(e,i,t,this._removeOverlay.bind(this))}},{key:"_addCellMarkers",value:function(e,i,t){this._processCellMarkers(e,i,t,this._addOverlay.bind(this))}},{key:"_rectangleDiff",value:function(e,i,t){this._rectangleDiffCoords(e,i,(function(i,s){t(i,s,e.z)}))}},{key:"_rectangleDiffCoords",value:function(e,i,t){var s,o,n=e.minX,r=e.minY,a=e.maxX,h=e.maxY,l=i.minX,d=i.minY,_=i.maxX,u=i.maxY;for(s=n;s<=a;s++){for(o=r;o<=h&&o<d;o++)t(s,o);for(o=Math.max(u+1,r);o<=h;o++)t(s,o)}for(o=Math.max(r,d);o<=Math.min(h,u);o++){for(s=Math.min(a+1,l)-1;s>=n;s--)t(s,o);for(s=Math.max(n,_+1);s<=a;s++)t(s,o)}}},{key:"_removeMarkerFromCell",value:function(e,i){for(var t=0,s=0;s<e.length;++s)e[s]===i&&(e.splice(s--,1),t++);return t}}]),e}();e.MarkerManager=r,Object.defineProperty(e,"__esModule",{value:!0})}));
